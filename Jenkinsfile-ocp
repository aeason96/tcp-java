def appName = 'tcp-java'
def DEV_ENV = 'development'
def DEFAULT_ENV = 'default'
def S2I_IMAGE = 'fabric8/s2i-java:latest-java11'
def REPO_URL = 'https://github.com/excellaco/tcp-java'
def AWS_PROVISIONING_SECRET = 'aws-provisioning-iam'

def secret_data

pipeline {
  agent none
  stages {
    stage ('Get AWS Credentials') {
      agent {
        label 'nodejs'
      }
      steps {
        script {
          secret_data = getSecret(DEFAULT_ENV, AWS_PROVISIONING_SECRET)
        }
      }
    }
    stage('Terraform Resources') {
      agent {
        kubernetes {
          label 'terraform-update'
          cloud 'openshift'
          defaultContainer 'terraform'
          yamlFile 'podtemplates/terraformpod.yml'
        }
      }
      steps {
        script {
          sh "export AWS_ACCESS_KEY_ID=\"${secret_data.ACCESS_KEY}\""
          sh "export AWS_SECRET_ACCESS_KEY=\"${secret_data.SECRET_ACCESS_KEY}\""
          sh "terraform init tcp-java-ocp"
          sh "terraform plan tcp-java-ocp"
        }
      }
    }
    stage('Unit Tests') {
      agent {
        kubernetes {
          label 'jdk11-testing'
          cloud 'openshift'
          defaultContainer 'java11'
          yamlFile 'podtemplates/gradlepod.yml'
        }
      }
      steps {
        container('java11') {
          gradle('clean verGJF')
          gradle('testNG')
          gradle('jacocoTestReport')
          gradle('jacocoTestCoverageVerification')
        }
      }
      post{
        always {
          junit '**/build/test-results/testNG/TEST-*.xml'
        }
      }
    }
    stage('Create Dev Configs') {
      agent {
        label 'nodejs'
      }
      when {
        not {
          expression {
            return doesBuildConfigExist(DEV_ENV, appName)
          }
        }
      }
      steps {
        script {
          openshift.withCluster() {
            openshift.withProject(DEV_ENV) {
              def app = openshift.newApp("${S2I_IMAGE}~${REPO_URL}", "--name='${appName}'", "--strategy=source")
              def logs = app.narrow('bc').logs('-f')
            }
          }
        }
      }
    }

    stage('Start Build') {
      agent {
        label 'nodejs'
      }
      steps {
        script {
          openshift.withCluster() {
            openshift.withProject(DEV_ENV) {
              openshift.startBuild(appName, "--follow")
            }
          }
        }
      }
    }
  }
}

def gradle(String... args) {
    sh "gradle ${args.join(' ')} -s"
}

def getSecret(String namespace, String secretName) {
  openshift.withCluster() {
    openshift.withProject(namespace) {
      return openshift.selector("secret", secretName).object().data
    }
  }
}

def doesBuildConfigExist(String namespace, String name) {
  openshift.withCluster() {
    openshift.withProject(namespace) {
      return openshift.selector("bc", name).exists()
    }
  }
}
